{% extends 'base.html' %}
{% load static %}
{% block meta %}
    <title>Keranjang Belanja</title>
{% endblock %}

{% block content %}
    <div class="min-h-screen bg-light">
        {% include 'navbar.html' %}

        <main class="container px-4 pt-24"> <!-- Margin atas diubah di sini -->
            <h2 class="text-3xl font-bold mb-6">Keranjang Belanja</h2>
            <div id="cart-items" class="bg-white rounded-lg shadow-sm overflow-hidden mb-8">
                <!-- Item keranjang akan ditambahkan di sini -->
            </div>

            <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-xl font-semibold">Total:</span>
                    <span id="cart-total" class="text-2xl font-bold">Rp 0</span>
                </div>
            </div>
        </main>
    </div>

    <script>
        const cartItemsContainer = document.getElementById('cart-items');
        const cartTotalElement = document.getElementById('cart-total');

        async function fetchCartItems() {
            try {
                const response = await fetch('/order/api/cart/'); // Ganti dengan URL endpoint untuk mendapatkan item keranjang
                const cartData = await response.json()
                const cartItems = cartData.items;
                console.log(cartData)

                if (cartItems.length === 0) {
                    cartItemsContainer.innerHTML = '<p class="text-xl text-center">Keranjang Anda kosong.</p>';
                    cartTotalElement.innerHTML = `Rp 0.00`;
                } else {
                    cartItemsContainer.innerHTML = ''; // Kosongkan container

                    cartItems.forEach(item => {

                        const itemElement = document.createElement('div');
                        itemElement.className = 'flex items-center border-b border-gray-200 py-4 px-6';
                        itemElement.innerHTML = `
                            <div class="flex-grow">
                                <h3 class="text-lg font-semibold">${item.name}</h3>
                                <p>Rp ${item.price.toLocaleString()}</p>
                            </div>
                            <div class="flex items-center">
                                <button id="decreaseQuantityBtn${item.id}" class="bg-black text-white w-6 h-6 text-sm rounded-full flex items-center justify-center mr-2">-</button>
                                <span class="mx-2 w-6 text-center">${item.quantity}</span>
                                <button id="increaseQuantityBtn${item.id}" class="bg-black text-white w-6 h-6 text-sm rounded-full flex items-center justify-center ml-2">+</button>
                            </div>
                            <button id="removeItemBtn${item.id}" class="ml-4 text-red-500">Hapus</button>
                        `;
                        cartItemsContainer.appendChild(itemElement);
                        const decreaseQuantityBtn = document.getElementById(`decreaseQuantityBtn${item.id}`)
                        const increaseQuantityBtn = document.getElementById(`increaseQuantityBtn${item.id}`)
                        const removeItemBtn = document.getElementById(`removeItemBtn${item.id}`)

                        decreaseQuantityBtn.addEventListener("click", () =>{
                            updateQuantity(item.id, item.quantity - 1)
                        })

                        increaseQuantityBtn.addEventListener("click", () =>{
                            updateQuantity(item.id, item.quantity + 1)
                        })

                        removeItemBtn.addEventListener("click", () =>{
                            updateQuantity(item.id, 0)
                        })
                    });

                    cartTotalElement.innerHTML = `Rp ${cartData.total}`;
                }
            } catch (error) {
                console.error('Error fetching cart items:', error);
            }
        }

        updateQuantity = async (itemId, newQuantity) => {
            if (newQuantity < 0) {
                return
            } else {
                const data = {
                    quantity: newQuantity
                }
                try {
                    const response = await fetch(`/order/api/update_item_quantity/${itemId}/`, {
                        method:"PATCH", 
                        body: JSON.stringify(data)
                    });
                    if (response.status === 200) {
                        fetchCartItems(); // Memperbarui tampilan setelah berhasil
                    }
                } catch (error) {
                    console.error('Error updating quantity:', error);
                }
            }
        };
        fetchCartItems();
    </script>
{% endblock %}
